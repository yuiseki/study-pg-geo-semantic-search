# 実験レポート (2025-12-28-001)

## 1. 目的
OpenStreetMap (OSM) の関東データを PostGIS に取り込み、PostgreSQL 単体で
「地理条件 + テキスト + ベクトル」のハイブリッド検索がどこまで実用的に動くかを検証する。

## 2. 実験環境
- PostgreSQL 17 + PostGIS + PGroonga + pgvector
- OSM: Geofabrik `kanto-latest.osm.pbf`
- Embedding: `snowflake-arctic-embed2:568m` (1024 dims, Ollama)
- ポート: 5435

## 3. データ準備
### 3.1 OSM 取り込み
- `make osm-download`
- `make osm-import`

### 3.2 変換 (raw -> search)
- `python scripts/transform.py --mode focused --reset`

**抽出ルールの拡張**
- `place_extract.yml` の focused に以下を追加:
  - `amenity=restaurant`
  - `amenity=fast_food`
  - `amenity=food_court`

**変換後件数 (search.places)**
- restaurant: 47,328
- convenience: 18,255
- school: 11,920
- barber: 8,716
- cafe: 8,376
- hospital: 4,641
- 合計: 99,236

### 3.3 埋め込み
- `python scripts/embed_places.py --batch-size 16`
- 完了時点: `search.place_embeddings` 99,236 件

## 4. 検索の実験設計
- クエリは手動で指定し、上位10件を人手で relevance ラベル付け
- 「name が空のレコードは評価が困難」だったため、検索時に `name IS NOT NULL AND name <> ''` を必須条件に変更

## 5. 検索結果とラベル付け

### 5.1 クエリ: 美容院
- 条件: 台東区付近 (lat 35.7126, lon 139.7798, radius 3000m)
- Top10: すべて `shop=hairdresser` で関連ありと判断
- ラベル: `q_biyouin_001` として qrels に記録

### 5.2 クエリ: レストラン
- 変更後 (restaurant 抽出追加) に再検証
- Top10: 全件 `amenity=restaurant` で関連ありと判断
- ラベル: `q_restaurant_001` として qrels に記録

### 5.3 クエリ: ファミレス
- Top10 が「ファミリーマート」(convenience) に寄り、関連なし
- ラベル: `q_famires_001` は該当なし

### 5.4 クエリ: コンビニ vs convenience store
- 日本語「コンビニ」:
  - Top10 がスターバックス (cafe) に偏り、関連なし
- 英語「convenience store」:
  - Top10 がミニストップ等の `shop=convenience` に集中
  - 8件を関連ありとしてラベル付け
- ラベル: `q_convenience_en_001`

## 6. 主な観察結果
1. **日本語クエリはベクトル検索が意図通り動かないケースがある**
   - 「コンビニ」で `shop=convenience` に結びつかず、cafe に吸われた。
2. **英語クエリだとタグ語彙と一致しやすく改善する**
   - 「convenience store」で期待通りのカテゴリが上位に出た。
3. **name が空のレコードは評価不能**
   - name 付きに限定するだけで、レストランの候補が妥当化した。

## 7. 原因の考察
- OSM の主要タグは英語 (`shop=convenience`, `amenity=restaurant`) だが、
  クエリは日本語で与えられるため、ベクトル側での意味橋渡しが弱い。
- PGroonga 側も `text_for_search` が英語タグ中心で、日本語語彙が薄い。
- 「同義語辞書なし」の方針では、自然言語からタグ語彙への変換が起きにくい。

## 8. 次の改善候補 (同義語辞書なしで可能な範囲)
- **name 補完**: `name:ja`, `name:en` などを `name` に統合
- **検索時のカテゴリ制約**: クエリごとに `category` を指定できるようにする
- **評価データ拡充**: クエリ数を増やし、nDCG/MRR/Recall を安定化させる

## 9. 成果物
- ラベル付け済みクエリと qrels:
  - `datasets/queries/tokyo_wards.jsonl`
  - `datasets/queries/qrels.tsv`

## 10. まとめ
- 抽出ルール拡張により「レストラン」系は改善。
- 日本語→英語タグへの意味対応は弱く、クエリの言語が結果に大きく影響。
- 今後は name 補完やカテゴリ制約など、辞書を使わずに精度を上げる工夫が必要。
